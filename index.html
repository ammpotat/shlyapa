<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lox</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; }
        #instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="instructions">Наведите камеру на здание с магазином или кафе</div>
    
    <a-scene embedded arjs='sourceType: webcam;'>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const apiKey = 'YOUR_API_KEY'; // Замените на ваш ключ API
        let userLocation = null;

        // Функция для получения геолокации
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            resolve(userLocation);
                        },
                        (error) => {
                            reject(error);
                        }
                    );
                } else {
                    reject(new Error("Геолокация не поддерживается вашим браузером."));
                }
            });
        }

        async function fetchShops() {
            if (!userLocation) return [];
            const response = await fetch(https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${userLocation.lat},${userLocation.lng}&radius=1500&type=cafe|store&key=${apiKey});
            const data = await response.json();
            return data.results;
        }

        async function updateMarkers() {
            try {
                await getLocation(); // Получаем геолокацию
                const shops = await fetchShops(); // Получаем магазины и кафе
                
                // Удаляем предыдущие маркеры
                const existingMarkers = document.querySelectorAll('.shop-marker');
                existingMarkers.forEach(marker => marker.parentNode.removeChild(marker));

                shops.forEach(shop => {
                    // Создаем новый маркер для каждого найденного магазина или кафе
                    const marker = document.createElement('a-entity');
                    marker.setAttribute('class', 'shop-marker');
                    marker.setAttribute('geometry', 'primitive: sphere; radius: 0.1');
                    marker.setAttribute('material', 'color: red');
                    marker.setAttribute('position', ${shop.geometry.location.lat} 0.5 ${shop.geometry.location.lng});
                    marker.setAttribute('look-at', '[camera]'); // Указываем, чтобы маркер всегда смотрел на камеру
                    
                    document.querySelector('a-scene').appendChild(marker);
                });
            } catch (error) {
                console.error('Ошибка:', error.message);
            }
        }

        // Запрашиваем разрешения на геолокацию и камеру
        async function startApp() {
            try {
                await getLocation();
                setInterval(updateMarkers, 5000); // Обновляем маркеры каждые 5 секунд
            } catch (error) {
                console.error('Ошибка:', error.message);
            }
        }

        startApp();
    </script>
</body>
</html>
